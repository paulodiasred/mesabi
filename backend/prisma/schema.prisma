// Prisma Schema for ComidaSmart
// Based on the nola-god-level database schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Core entities
model Brand {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  subBrands     SubBrand[]
  stores        Store[]
  channels      Channel[]
  categories    Category[]
  products      Product[]
  items         Item[]
  optionGroups  OptionGroup[]
  paymentTypes  PaymentType[]
  coupons       Coupon[]
}

model SubBrand {
  id        Int      @id @default(autoincrement())
  brandId   Int      @map("brand_id")
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  brand      Brand       @relation(fields: [brandId], references: [id])
  stores     Store[]
  categories Category[]
  products   Product[]
  items      Item[]
  optionGroups OptionGroup[]
  customers  Customer[]
}

model Store {
  id             Int       @id @default(autoincrement())
  brandId        Int?      @map("brand_id")
  subBrandId     Int?      @map("sub_brand_id")
  name           String    @db.VarChar(255)
  city           String?   @db.VarChar(100)
  state          String?   @db.VarChar(2)
  district       String?   @db.VarChar(100)
  addressStreet  String?   @map("address_street") @db.VarChar(200)
  addressNumber  Int?      @map("address_number")
  zipcode        String?   @db.VarChar(10)
  latitude       Decimal?  @db.Decimal(9, 6)
  longitude      Decimal?  @db.Decimal(9, 6)
  isActive       Boolean   @default(true) @map("is_active")
  isOwn          Boolean   @default(false) @map("is_own")
  isHolding      Boolean   @default(false) @map("is_holding")
  creationDate   DateTime? @map("creation_date") @db.Date
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  brand          Brand?    @relation(fields: [brandId], references: [id])
  subBrand       SubBrand? @relation(fields: [subBrandId], references: [id])
  sales          Sale[]
  customers      Customer[]
}

model Channel {
  id          Int       @id @default(autoincrement())
  brandId     Int?      @map("brand_id")
  name        String    @db.VarChar(100)
  description String?   @db.VarChar(255)
  type        String?   @db.Char(1) // P=Presencial, D=Delivery
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  brand       Brand?    @relation(fields: [brandId], references: [id])
  sales       Sale[]
}

model Category {
  id         Int       @id @default(autoincrement())
  brandId    Int?      @map("brand_id")
  subBrandId Int?      @map("sub_brand_id")
  name       String    @db.VarChar(200)
  type       String    @default("P") @db.Char(1) // P=Produto, I=Item
  posUuid    String?   @map("pos_uuid") @db.VarChar(100)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(6)

  brand        Brand?       @relation(fields: [brandId], references: [id])
  subBrand     SubBrand?    @relation(fields: [subBrandId], references: [id])
  products     Product[]
  items        Item[]
  optionGroups OptionGroup[]
}

model Product {
  id         Int       @id @default(autoincrement())
  brandId    Int?      @map("brand_id")
  subBrandId Int?      @map("sub_brand_id")
  categoryId Int?      @map("category_id")
  name       String    @db.VarChar(500)
  posUuid    String?   @map("pos_uuid") @db.VarChar(100)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(6)

  brand          Brand?         @relation(fields: [brandId], references: [id])
  subBrand       SubBrand?      @relation(fields: [subBrandId], references: [id])
  category       Category?      @relation(fields: [categoryId], references: [id])
  productSales   ProductSale[]
}

model Item {
  id         Int       @id @default(autoincrement())
  brandId    Int?      @map("brand_id")
  subBrandId Int?      @map("sub_brand_id")
  categoryId Int?      @map("category_id")
  name       String    @db.VarChar(500)
  posUuid    String?   @map("pos_uuid") @db.VarChar(100)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(6)

  brand              Brand?               @relation(fields: [brandId], references: [id])
  subBrand           SubBrand?            @relation(fields: [subBrandId], references: [id])
  category           Category?            @relation(fields: [categoryId], references: [id])
  itemProductSales   ItemProductSale[]
  itemItemProductSales ItemItemProductSale[]
}

model OptionGroup {
  id         Int       @id @default(autoincrement())
  brandId    Int?      @map("brand_id")
  subBrandId Int?      @map("sub_brand_id")
  categoryId Int?      @map("category_id")
  name       String    @db.VarChar(500)
  posUuid    String?   @map("pos_uuid") @db.VarChar(100)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(6)

  brand               Brand?               @relation(fields: [brandId], references: [id])
  subBrand            SubBrand?            @relation(fields: [subBrandId], references: [id])
  category            Category?            @relation(fields: [categoryId], references: [id])
  itemProductSales    ItemProductSale[]
  itemItemProductSales ItemItemProductSale[]
}

model Customer {
  id                      Int       @id @default(autoincrement())
  customerName            String?   @map("customer_name") @db.VarChar(100)
  email                   String?   @db.VarChar(100)
  phoneNumber             String?   @map("phone_number") @db.VarChar(50)
  cpf                     String?   @db.VarChar(100)
  birthDate               DateTime? @map("birth_date") @db.Date
  gender                  String?   @db.VarChar(10)
  storeId                 Int?      @map("store_id")
  subBrandId              Int?      @map("sub_brand_id")
  registrationOrigin      String?   @map("registration_origin") @db.VarChar(20)
  agreeTerms              Boolean   @default(false) @map("agree_terms")
  receivePromotionsEmail  Boolean   @default(false) @map("receive_promotions_email")
  receivePromotionsSms    Boolean   @default(false) @map("receive_promotions_sms")
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  store       Store?    @relation(fields: [storeId], references: [id])
  subBrand    SubBrand? @relation(fields: [subBrandId], references: [id])
  sales       Sale[]
}

// Sales and transactions
model Sale {
  id                  Int      @id @default(autoincrement())
  storeId             Int      @map("store_id")
  subBrandId          Int?     @map("sub_brand_id")
  customerId          Int?     @map("customer_id")
  channelId           Int      @map("channel_id")
  codSale1            String?  @map("cod_sale1") @db.VarChar(100)
  codSale2            String?  @map("cod_sale2") @db.VarChar(100)
  createdAt           DateTime @map("created_at") @db.Timestamp(6)
  customerName        String?  @map("customer_name") @db.VarChar(100)
  saleStatusDesc      String   @map("sale_status_desc") @db.VarChar(100)

  // Financial values
  totalAmountItems    Decimal  @map("total_amount_items") @db.Decimal(10, 2)
  totalDiscount       Decimal  @default(0) @map("total_discount") @db.Decimal(10, 2)
  totalIncrease       Decimal  @default(0) @map("total_increase") @db.Decimal(10, 2)
  deliveryFee         Decimal  @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  serviceTaxFee       Decimal  @default(0) @map("service_tax_fee") @db.Decimal(10, 2)
  totalAmount         Decimal  @map("total_amount") @db.Decimal(10, 2)
  valuePaid           Decimal  @default(0) @map("value_paid") @db.Decimal(10, 2)

  // Operational metrics
  productionSeconds   Int?     @map("production_seconds")
  deliverySeconds     Int?     @map("delivery_seconds")
  peopleQuantity      Int?     @map("people_quantity")

  // Metadata
  discountReason      String?  @map("discount_reason") @db.VarChar(300)
  increaseReason      String?  @map("increase_reason") @db.VarChar(300)
  origin              String   @default("POS") @db.VarChar(100)

  store               Store             @relation(fields: [storeId], references: [id])
  channel             Channel           @relation(fields: [channelId], references: [id])
  customer            Customer?         @relation(fields: [customerId], references: [id])
  productSales        ProductSale[]
  payments            Payment[]
  deliverySales       DeliverySale[]
  deliveryAddresses   DeliveryAddress[]
  couponSales         CouponSale[]
}

model ProductSale {
  id           Int      @id @default(autoincrement())
  saleId       Int      @map("sale_id")
  productId    Int      @map("product_id")
  quantity     Float
  basePrice    Float    @map("base_price")
  totalPrice   Float    @map("total_price")
  observations String?  @db.VarChar(300)

  sale                  Sale                 @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product               Product              @relation(fields: [productId], references: [id])
  itemProductSales      ItemProductSale[]
}

model ItemProductSale {
  id               Int      @id @default(autoincrement())
  productSaleId    Int      @map("product_sale_id")
  itemId           Int      @map("item_id")
  optionGroupId    Int?     @map("option_group_id")
  quantity         Float
  additionalPrice  Float    @map("additional_price")
  price            Float
  amount           Float    @default(1)
  observations     String?  @db.VarChar(300)

  productSale            ProductSale        @relation(fields: [productSaleId], references: [id], onDelete: Cascade)
  item                   Item               @relation(fields: [itemId], references: [id])
  optionGroup            OptionGroup?       @relation(fields: [optionGroupId], references: [id])
  itemItemProductSales   ItemItemProductSale[]
}

model ItemItemProductSale {
  id                Int      @id @default(autoincrement())
  itemProductSaleId Int      @map("item_product_sale_id")
  itemId            Int      @map("item_id")
  optionGroupId     Int?     @map("option_group_id")
  quantity          Float
  additionalPrice   Float    @map("additional_price")
  price             Float
  amount            Float    @default(1)

  itemProductSale   ItemProductSale    @relation(fields: [itemProductSaleId], references: [id], onDelete: Cascade)
  item              Item               @relation(fields: [itemId], references: [id])
  optionGroup       OptionGroup?       @relation(fields: [optionGroupId], references: [id])
}

// Delivery
model DeliverySale {
  id           Int      @id @default(autoincrement())
  saleId       Int      @map("sale_id")
  courierId    String?  @map("courier_id") @db.VarChar(100)
  courierName  String?  @map("courier_name") @db.VarChar(100)
  courierPhone String?  @map("courier_phone") @db.VarChar(100)
  courierType  String?  @map("courier_type") @db.VarChar(100)
  deliveredBy  String?  @map("delivered_by") @db.VarChar(100)
  deliveryType String?  @map("delivery_type") @db.VarChar(100)
  status       String?  @db.VarChar(100)
  deliveryFee  Float?   @map("delivery_fee")
  courierFee   Float?   @map("courier_fee")
  timing       String?  @db.VarChar(100)
  mode         String?  @db.VarChar(100)

  sale              Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  deliveryAddresses DeliveryAddress[]
}

model DeliveryAddress {
  id               Int      @id @default(autoincrement())
  saleId           Int      @map("sale_id")
  deliverySaleId   Int?     @map("delivery_sale_id")
  street           String?  @db.VarChar(200)
  number           String?  @db.VarChar(20)
  complement       String?  @db.VarChar(200)
  formattedAddress String?  @map("formatted_address") @db.VarChar(500)
  neighborhood     String?  @db.VarChar(100)
  city             String?  @db.VarChar(100)
  state            String?  @db.VarChar(50)
  country          String?  @db.VarChar(100)
  postalCode       String?  @map("postal_code") @db.VarChar(20)
  reference        String?  @db.VarChar(300)
  latitude         Float?
  longitude        Float?

  sale         Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  deliverySale DeliverySale? @relation(fields: [deliverySaleId], references: [id], onDelete: Cascade)
}

// Payments
model PaymentType {
  id          Int       @id @default(autoincrement())
  brandId     Int?      @map("brand_id")
  description String    @db.VarChar(100)

  brand     Brand?    @relation(fields: [brandId], references: [id])
  payments  Payment[]
}

model Payment {
  id            Int       @id @default(autoincrement())
  saleId        Int       @map("sale_id")
  paymentTypeId Int?      @map("payment_type_id")
  value         Decimal   @db.Decimal(10, 2)
  isOnline      Boolean   @default(false) @map("is_online")
  description   String?   @db.VarChar(100)
  currency      String    @default("BRL") @db.VarChar(10)

  sale         Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentType  PaymentType? @relation(fields: [paymentTypeId], references: [id])
}

// Coupons
model Coupon {
  id            Int       @id @default(autoincrement())
  brandId       Int?      @map("brand_id")
  code          String    @db.VarChar(50)
  discountType  String?   @map("discount_type") @db.Char(1) // 'p' percentage, 'f' fixed
  discountValue Decimal?  @map("discount_value") @db.Decimal(10, 2)
  isActive      Boolean   @default(true) @map("is_active")
  validFrom     DateTime? @map("valid_from") @db.Timestamp(6)
  validUntil    DateTime? @map("valid_until") @db.Timestamp(6)

  brand       Brand?      @relation(fields: [brandId], references: [id])
  couponSales CouponSale[]
}

model CouponSale {
  id          Int       @id @default(autoincrement())
  saleId      Int?      @map("sale_id")
  couponId    Int?      @map("coupon_id")
  value       Float?
  target      String?   @db.VarChar(100)
  sponsorship String?   @db.VarChar(100)

  sale    Sale?    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  coupon  Coupon?  @relation(fields: [couponId], references: [id])
}

